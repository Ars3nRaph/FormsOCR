let state={pid:null,layout:{workspace:null,rois:[]},img:null,pdf:false,pdfPages:null};const $=s=>document.querySelector(s);const toast=m=>{const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2e3)};async function jfetch(u,o={}){const r=await fetch(u,o);const tx=await r.text();let j;try{j=JSON.parse(tx)}catch{j={ok:false,error:tx}}return {ok:r.ok&&(j.ok!==false),data:j}}const canvas=$('#canvas'),ctx=canvas.getContext('2d'),wrap=document.querySelector('.canvasWrap');let zoom={s:1,tx:0,ty:0};function draw(){ctx.setTransform(1,0,0,1,0,0);ctx.clearRect(0,0,canvas.width,canvas.height);if(state.img){ctx.setTransform(zoom.s,0,0,zoom.s,zoom.tx,zoom.ty);ctx.drawImage(state.img,0,0)}}function fit(){if(!state.img)return;const cw=wrap.clientWidth,ch=wrap.clientHeight,sw=canvas.width,sh=canvas.height;const s=Math.min(cw/sw,ch/sh);zoom.s=s;zoom.tx=(cw-sw*s)/2*(canvas.width/cw);zoom.ty=(ch-sh*s)/2*(canvas.height/ch);draw()}function loadTpl(){const img=new Image();img.onload=()=>{state.img=img;canvas.width=img.width;canvas.height=img.height;fit()};img.src=`/api/projects/${state.pid}/template-image?ts=${Date.now()}`}async function refresh(){const {ok,data}=await jfetch('/api/projects');if(!ok)return;const ul=$('#projList');ul.innerHTML='';(data.projects||[]).forEach(p=>{const li=document.createElement('li');li.textContent=p.name+(p.pdf?` [pdf p${p.pdf_page||1}/${p.pdf_pages||'?'}]`:'');li.onclick=()=>open(p.id);ul.appendChild(li)})}async function open(pid){const {ok,data}=await jfetch(`/api/projects/${pid}`);if(!ok){toast('Open err');return}state.pid=pid;state.pdf=!!data.is_pdf;state.pdfPages=data.pdf_pages||null;$('#tmplPdfInfo').textContent=state.pdf?`PDF (page ${data.pdf_page||1}/${data.pdf_pages||'?'})`:'Image';if(data.project.template_path)loadTpl();$('#btnUpload').disabled=false;$('#btnApplyPdfPage').disabled=!state.pdf;}$('#btnCreate').onclick=async()=>{const n=$('#newProjName').value.trim();if(!n)return;const fd=new FormData();fd.append('name',n);const r=await fetch('/api/projects',{method:'POST',body:fd});const j=await r.json();if(!r.ok||j.ok===false)return toast('create err');refresh();open(j.project_id)};$('#btnRefresh').onclick=refresh;$('#tmplFile').addEventListener('change',e=>{$('#btnUpload').disabled=!e.target.files.length});$('#btnUpload').onclick=async()=>{const f=$('#tmplFile').files[0];const fd=new FormData();fd.append('file',f);fd.append('page',$('#tmplPdfPage').value||'1');const {ok,data}=await jfetch(`/api/projects/${state.pid}/template`,{method:'POST',body:fd});if(!ok){toast(data.error||'upload err');return}state.pdf=!!data.from_pdf;state.pdfPages=data.pages||null;$('#tmplPdfInfo').textContent=state.pdf?`PDF (page ${data.page||1}/${data.pages||'?'})`:'Image';$('#btnApplyPdfPage').disabled=!state.pdf;loadTpl();};$('#btnApplyPdfPage').onclick=async()=>{if(!state.pdf){toast('Template non PDF');return}let p=parseInt($('#tmplPdfPage').value||'1',10);if(state.pdfPages)p=Math.max(1,Math.min(state.pdfPages,p));const fd=new FormData();fd.append('page',String(p));const {ok,data}=await jfetch(`/api/projects/${state.pid}/template-page`,{method:'POST',body:fd});if(!ok){toast(data.error||'change err');return}$('#tmplPdfPage').value=data.page;$('#tmplPdfInfo').textContent=`PDF (page ${data.page}/${data.pages})`;loadTpl();};refresh();